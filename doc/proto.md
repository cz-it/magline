#协议部分

参照tconnd/nats/nsq/redis/zeromq/nng(nanomsg)

magline 只解决了tcp链接管理和鉴权的加密的问题，其他问题不解决。

所以协议是一个自定义的协议.结构为:

+++++++++++++++|++++++++++++++++++++++++++++
   frame head  |    msg header | msg body
+++++++++++++++|+++++++++++++++++++++++++++

这样的一个结构为一帧数据

frame head 定义为：

    Byte/      0       |       1       |       2       |       3       |
        /              |               |               |               |
       |0 1 2 3 4 5 6 7|0 1 2 3 4 5 6 7|0 1 2 3 4 5 6 7|0 1 2 3 4 5 6 7|
       +---------------+---------------+---------------+---------------+
            Magic      |    Version    |            CMD
       +---------------+---------------+---------------+---------------+
                 Head Optional         |          Head Length  
       +---------------+---------------+---------------+---------------+
                                      Seq
       +---------------+---------------+---------------+---------------+
                                 Message  Length
       +---------------+---------------+---------------+---------------+

一个完整的帧头结构如上,总共16个字节


为啥要使用自定义格式？ 

因为与Magline来说，这些协议，一个是有限的，二个是基本是固定不变的，如有改变，也可以通过head来
做只增不减的思路进行向下兼容.

## Magic
magic的作用用来区分控制消息和数据消息.

* 控制消息，比如连接建立，心跳
* 数据消息，如果Req-Rep ， Push

## 2. CMD的定义

| CMD |值| 含义 | 
|---|---|---|
|SYN| 0x1|Client主动创建连接或者断线重连|
|ACK| 0x2|对SYN的正确相应 |
|ERR| 0x3|出错|
|PIN| 0x4|ping消息|
|PON| 0x5|pong消息|
|REQ| 0x6|request 消息|
|REP| 0x7|response 消息|
|PSH| 0x8|push消息|
|FIN| 0x9|主动断开连接消息|

尽量保持只有这几个协议

## 3. 交互流程
S1: Client发送SYN给服务器
S2-1：如果没问题，建立成功，Server回ACK
S2-2: 如果有问题，Server回ERR 然后接着回FIN，然后关闭连接
S3: Client 按自己的频率发送ping心跳给Server，对应的Server会回pong。
S4: Client 发送Req消息给服务器
S5: Server回Rep消息
S6: Server主动发送Push消息给Client
S7: Client发送reSYN消息给Server
S8: 成功时，Server回ACK
S9: 主动关闭消息FIN


## 4. 协议

### 4.1 SYN

       +---------------+---------------+---------------+---------------+
                                Custom Random
       +---------------+---------------+---------------+---------------+
                             Custom Public Key
       +---------------+---------------+---------------+---------------+

### 4.2 ACK

       +---------------+---------------+---------------+---------------+
                                Server Random
       +---------------+---------------+---------------+---------------+
                             Server Public Key
       +---------------+---------------+---------------+---------------+
                                AES( K + sid )
       +---------------+---------------+---------------+---------------+

        
### 4.3 ERR

       +---------------+---------------+---------------+---------------+
                                Business CMD
       +---------------+---------------+---------------+---------------+
                                Error Number
       +---------------+---------------+---------------+---------------+

### 4.4 PING

       +---------------+---------------+---------------+---------------+
                                Ping Number
       +---------------+---------------+---------------+---------------+

### 4.5 PONG

       +---------------+---------------+---------------+---------------+
                                Ping Number
       +---------------+---------------+---------------+---------------+

### 4.6 FIN

       +---------------+---------------+---------------+---------------+
                                Reason Number
       +---------------+---------------+---------------+---------------+

### 4.7 REQ

       +---------------+---------------+---------------+---------------+
                                Business CMD
        +---------------+---------------+---------------+---------------+
                                    H
        +---------------+---------------+---------------+---------------+
                                    M
        +---------------+---------------+---------------+---------------+
                                    A
        +---------------+---------------+---------------+---------------+
                                    C
        +---------------+---------------+---------------+---------------+

        Data ...

### 4.8 REP

       +---------------+---------------+---------------+---------------+
                                Business CMD
        +---------------+---------------+---------------+---------------+
                                    H
        +---------------+---------------+---------------+---------------+
                                    M
        +---------------+---------------+---------------+---------------+
                                    A
        +---------------+---------------+---------------+---------------+
                                    C
        +---------------+---------------+---------------+---------------+

        Data ...   

### 4.9 PSH

       +---------------+---------------+---------------+---------------+
                                Business CMD
        +---------------+---------------+---------------+---------------+
                                    H
        +---------------+---------------+---------------+---------------+
                                    M
        +---------------+---------------+---------------+---------------+
                                    A
        +---------------+---------------+---------------+---------------+
                                    C
        +---------------+---------------+---------------+---------------+

        Data ...             